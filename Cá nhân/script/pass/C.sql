/*---------------------------------------------------------- 
MASV: 18120397
HO TEN: NGUYEN DANG HONG HUY
LAB: 03 
NGAY: 23/04/2021
----------------------------------------------------------*/ 
USE [QLSV]
GO

CREATE PROCEDURE SP_INS_SINHVIEN 
	@MASV	NVARCHAR(20),
	@HOTEN	NVARCHAR(100),
	@NGAYSINH	DATETIME,
	@DIACHI NVARCHAR(200),
	@MALOP	VARCHAR(20),
	@TENDN	NVARCHAR(100),
	@MATKHAU	VARCHAR(100)
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @MATKHAU_MD5 VARBINARY(100);
	SET @MATKHAU_MD5 = CONVERT(VARBINARY(100),HASHBYTES('MD5', @MATKHAU));
	INSERT INTO DBO.SINHVIEN
	VALUES (@MASV, @HOTEN, @NGAYSINH, @DIACHI, @MALOP, @TENDN, @MATKHAU_MD5)
END
GO

CREATE SYMMETRIC KEY SK  
WITH  
    ALGORITHM = AES_256  
    ENCRYPTION BY PASSWORD = '18120397'; 
GO

CREATE PROCEDURE SP_INS_NHANVIEN
	@MANV	VARCHAR(20) ,
	@HOTEN	NVARCHAR(100),
	@EMAIL	VARCHAR (20),
	@LUONG	VARCHAR(100),
	@TENDN	NVARCHAR(100),
	@MATKHAU	VARCHAR(100)
AS
BEGIN
	SET NOCOUNT ON;
	OPEN SYMMETRIC KEY SK DECRYPTION BY PASSWORD = '18120397';

	DECLARE @MATKHAU_SHA1 VARBINARY(100);
	SET @MATKHAU_SHA1 = CONVERT(VARBINARY(100),HASHBYTES('SHA1', @MATKHAU));

	DECLARE @LUONG_AES256 VARBINARY(100);
	SET @LUONG_AES256 = ENCRYPTBYKEY(KEY_GUID('SK'), CONVERT(VARBINARY(100),@LUONG));

	INSERT INTO DBO.NHANVIEN
	VALUES (@MANV, @HOTEN, @EMAIL, @LUONG_AES256, @TENDN, @MATKHAU_SHA1);

	CLOSE SYMMETRIC KEY SK;
END
GO

CREATE PROCEDURE SP_SEL_NHANVIEN
AS
BEGIN
	SET NOCOUNT ON;
	OPEN SYMMETRIC KEY SK DECRYPTION BY PASSWORD = '18120397';

	SELECT MANV, HOTEN, EMAIL, CONVERT(VARCHAR(100), DECRYPTBYKEY(LUONG)) "LUONGCB"
	FROM NHANVIEN

	CLOSE SYMMETRIC KEY SK;
END
GO

EXEC SP_INS_SINHVIEN '18120397', N'Nguyễn Đặng Hồng Huy', '03/01/2000', N'Gia Lai', NULL, '18120397', 'ndhhuy12345'
GO
EXEC SP_INS_SINHVIEN '18120399', N'Phạm Đức Huy', '07/03/2000', N'Lâm Đồng', NULL, '18120399', 'pdhuy12345'
GO
EXEC SP_INS_SINHVIEN '18120423', N'Trịnh Tấn Khoa', '12/26/2000', N'An Giang', NULL, '18120423', 'ttkhoa12345'
GO


EXEC SP_INS_NHANVIEN 'NV03', N'NGUYEN VAN A', 'nva@yahoo.com', '3000000', 'NVA', '123456'
GO
EXEC SP_INS_NHANVIEN 'NV02', N'NGUYEN VAN B', 'nvb@yahoo.com', '2000000', 'NVB', '1234567'
GO

SELECT * FROM DBO.SINHVIEN
GO 
SELECT * FROM DBO.NHANVIEN
GO 
EXEC SP_SEL_NHANVIEN
GO